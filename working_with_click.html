<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TWA Service Area</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.31/"></script>
  <style>
    html, body, #viewDiv {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    #legendContainer {
      position: absolute;
      bottom: 50px;
      right: 10px;
      /* width: 300px; */
      max-height: 400px;
      overflow: hidden;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    #legendContainer.hidden {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none; /* Prevent interactions when hidden */
    }

    #legendToggle {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 10px;
      background-color: #0079c1;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      z-index: 999;
    }

    #legendToggle:hover {
      background-color: #005f91;
    }

    .report-links{
        display: flex;
        justify-content: center;
        text-align: center;
        flex-direction: row;
        gap:2rem;
        color: blue;
        font-weight: bold;
        font-size: medium;
    }

    .report-links a {
      color: blue;
      text-decoration: none;
      font-weight: bold;
      font-size: medium;
    }

    .report-links a:hover {
      text-decoration: underline;
    }

    .search-popup-address {
      font-weight: bold;
      text-align: center;
    }

    .search-popup-outside-searcharea{
        text-align: center;
    }
    .search-popup-container{
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .esri-popup__main-container{
        width: 300px !important;
    }

    calcite-action-bar{
        display: flex;
        justify-content: center;
    }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <div id="legendContainer">
    <div id="legendContent"></div>
  </div>
  <button id="legendToggle">Hide Legend</button>
  <script>
   require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer"
], function (Map, MapView, FeatureLayer) {

  const featureLayer = new FeatureLayer({
    url: "https://services3.arcgis.com/PPOHFcbrL50ceHvX/arcgis/rest/services/Servicearea_shapefile/FeatureServer/0",
    outFields: ["*"],
    popupEnabled: false // disable default popup so we can control it manually
  });

  console.log("â„¹ï¸ Feature layer created:", featureLayer.url);

  const map = new Map({
    basemap: "streets-navigation-vector",
    layers: [featureLayer]
  });

  const view = new MapView({
    container: "viewDiv",
    map,
    center: [-81.3, 28.2],
    zoom: 10
  });

  // Wait for both the layer and view to be ready
  featureLayer.when(() => {
    console.log("âœ… Feature layer loaded:", featureLayer.url);

    view.whenLayerView(featureLayer).then((layerView) => {
      console.log("âœ… Layer view ready:", layerView);

      // Listen for map clicks
      view.on("click", (event) => {
        console.log("ðŸ–±ï¸ Map clicked at:", event.mapPoint.latitude, event.mapPoint.longitude);

        view.hitTest(event).then((response) => {
          console.log("ðŸ” HitTest raw results:", response.results);

          if (!response.results.length) {
            console.log("âŒ No features found at clicked location.");

            // Show fallback popup
            view.popup.open({
              title: "No Feature Detected",
              content: "You clicked on an empty part of the map.",
              location: event.mapPoint
            });
            return;
          }

          // Log all layers from the hit test for debugging
          console.log("ðŸ§© Layers in hitTest:", response.results.map(r => r.graphic?.layer?.id));

          // Match result by URL instead of ID (more stable)
          const result = response.results.find(
            (r) => r.graphic?.layer?.url === featureLayer.url
          );

          if (!result) {
            console.log("âš ï¸ No result matched this layer:", featureLayer.url);

            view.popup.open({
              title: "No Matching Layer Found",
              content: "You clicked on another layer or background.",
              location: event.mapPoint
            });
            return;
          }

          // Feature found!
          const attrs = result.graphic.attributes;
          console.log("Feature clicked:", attrs);

          let message;
          if (attrs.POLIT_NAME === "St. cloud") {
            message = "You clicked inside the St. Cloud service area.";
          } else if (attrs.POLIT_NAME === "Central") {
            message = "This is the Central area.";
          } else {
            message = `You clicked in ${attrs.POLIT_NAME || "an unknown"} area.`;
          }

          // ðŸ§­ Ensure popup closes any existing one before reopening
            view.popup.close();


            setTimeout(() => {
                view.popup.open({
                    title: "Service Area Info",
                    content: `<p>${message}</p>`,
                    location: result.mapPoint || event.mapPoint, // âœ… safer fallback
                    fetchFeatures: false // prevent auto-popup from overriding
                });

                // âœ… make sure popup is enabled and visible
                view.popup.visible = true;
            }, 50);

        });
      });
    });
  });
});


  </script>
</body>
</html>
